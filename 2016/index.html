<?
/*+===================================================================
  File:      index.html
  
  Author:    Ivan Ng
             Information Secretary of Session 2013 - 2014
  
  Created:   17 Oct 2016
  
  Updated:   1 Nov 2016
  
  Summary:   Client-side implementation of the System, which is a Web
             UI intended to be used by Cosplay Party helpers/staff.
  
----------------------------------------------------------------------
  This program and any source codes of it may not be reproduced or 
  distributed in any form without consent from The Animation and 
  Comics Association, HKUSU or from the author of this program.
===================================================================+*/
?>
<!DOCTYPE html>
<html>

<head>
<meta charset="UTF-8">
<meta data-name="app_version" content="<?= APP_VERSION ?>" />
<? 
var modeCHECKIN = 
{
  color: '#ad3c46'
};
var modeLUGGAGE =
{
  color: '#5e2f82'
};
?>
<style>
/*********************************************************************
  Body styles
*******************************************************************+*/
body{
  font-family: "Microsoft JhengHei", Tahoma, Verdana, Arial, sans-serif;
  font-size:  24px;
  background-color: #000000;
  margin: 2em;
  background-image: url(https://i.imgur.com/AIIJ9YM.png);
  background-repeat: no-repeat;
  background-position: right top;
  background-size: 450px 387px;
  background-attachment: fixed;
}
body.modeCHECKIN{
  background-color: <?= modeCHECKIN.color ?>;
}
body.modeLUGGAGE{
  background-color: <?= modeLUGGAGE.color ?>;
}
/*********************************************************************
  Header styles
*******************************************************************+*/
header{
  color: #ffffff;
}
/*********************************************************************
  Footer styles
*******************************************************************+*/
footer{
  font-size: 0.85em;
  color: #ffffff;
}
footer p{
  text-align: center;
}
footer p a{
  color: white;
}
/*********************************************************************
  Navigation (Mode Buttons) styles
*******************************************************************+*/
nav{
  padding: 0;
  margin-bottom: -1px;
}
.buttonMode{
  margin: 0;
  padding: 14px 24px 15px;
  background-color: rgba(255,255,255,0.5);
  cursor: pointer;
  display: inline-block;
}
.buttonModeCurrent{
  padding: 16px 24px;
  font-weight: bold;
  background-color: #ffffff;
  border-top: 1px solid #666666;
  border-left: 1px solid #666666;
  border-right: 1px solid #666666;
  border-bottom: 0;
}
body.modeCHECKIN .buttonModeCurrent{
  color: <?= modeCHECKIN.color ?>;
}
body.modeLUGGAGE .buttonModeCurrent{
  color: <?= modeLUGGAGE.color ?>;
}
/*********************************************************************
  Panels styles
*******************************************************************+*/
#panels{
  background-color: #ffffff;
  border: 1px solid #666666;
  padding: 2em;
  box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3);
}
#messageError{
  color: red;
}
input[type="text"]{
  font-family:inherit;
  font-size: inherit;
  padding: 0.5em;
  border: solid 1px #c8c8c8;
  transition: border 0.2s, background-color 0.2s;
  width: 15em;
}
input[type="text"]:focus{
  outline: none;
  border-color: #0099CC;
  background-color: #ffffee;
}
body.modeCHECKIN input[type="text"]:focus{
  border-color: <?= modeCHECKIN.color ?>;
}
body.modeLUGGAGE input[type="text"]:focus{
  border-color: <?= modeLUGGAGE.color ?>;
}
input[type="button"]{
  font-family:inherit;
  font-size: inherit;
  color: #ffffff;
  padding: 0.5em 0.8em;
  border: 1px solid black;
  background-color: black;
  cursor: pointer;
  transition: color 0.2s, background-color 0.2s;
}
body.modeCHECKIN input[type="button"]{
  border-color: <?= modeCHECKIN.color ?>;
  background-color: <?= modeCHECKIN.color ?>;
}
body.modeLUGGAGE input[type="button"]{
  border-color: <?= modeLUGGAGE.color ?>;
  background-color: <?= modeLUGGAGE.color ?>;
}
body.modeCHECKIN input[type="button"]:hover{
  background-color: #ffffff;
  color: <?= modeCHECKIN.color ?>;
}
body.modeLUGGAGE input[type="button"]:hover{
  background-color: #ffffff;
  color: <?= modeLUGGAGE.color ?>;
}

/*********************************************************************
  Subpanel GroupEachParti & PartiInfo Styles
*******************************************************************+*/
.groupEachParti{
  margin-bottom: 2em;
  padding-bottom: 2em;
  border-bottom: 1px solid #666666;
}

.groupEachParti:last-child {
  margin-bottom: 0;
  padding-bottom: 0;
  border-bottom: 0;
}

.subpanelPartiInfo{
  margin-bottom: 2em;
}
.subpanelPartiInfo table, td, tr{
  border: 0;
  border-spacing: 10px;
  border-collapse: separate;
}
.subpanelPartiInfo table{
  width: 100%;
}
.subpanelPartiInfo th{
  font-weight: normal;
  width:1%;
  white-space:nowrap;
}
.subpanelPartiInfo .thLuggage{
  width: 50%;
}

body.modeCHECKIN .subpanelPartiInfo th{
  color: <?= modeCHECKIN.color ?>;
}
body.modeLUGGAGE .subpanelPartiInfo th{
  color: <?= modeLUGGAGE.color ?>;
}
body.modeCHECKIN .subpanelPartiInfo td{
  border-bottom: 1px solid <?= modeCHECKIN.color ?>;
}
body.modeLUGGAGE .subpanelPartiInfo td{
  border-bottom: 1px solid <?= modeLUGGAGE.color ?>;
}

.subpanelPartiInfo .tdLuggage{
  left: 10px;
}

body.modeCHECKIN .subpanelPartiInfo .tdLuggage{
  border: 1px solid <?= modeCHECKIN.color ?>;
}

body.modeLUGGAGE .subpanelPartiInfo .tdLuggage{
  border: 1px solid <?= modeLUGGAGE.color ?>;
}

.subpanelPartiInfo .messageDisplay{
  color: red;
}

.subpanelPartiInfo .checkInStatus0{
  color: #ff0f77;
  font-weight: bold;
}
.subpanelPartiInfo .checkInStatus1{
  color: #44c113;
  font-weight: bold;
}


/*********************************************************************
  Button Search Again Styles
*******************************************************************+*/
.subpanelCheckIn, .subpanelLuggage{
  position: relative;
}
.buttonSearchAgain{
  position: absolute;
  right: 0;
}
/*********************************************************************
  Subpanel Luggage Styles
*******************************************************************+*/
.groupInputEachLuggage{
  margin-bottom: 0.5em;
}
input[type=checkbox] + label {
    display: inline-block;
    cursor: pointer;
    position: relative;
    padding-left: 35px;
    margin-left: 0px;
    margin-right: 15px;
    font-size: 25px;
}
input[type=checkbox] + label:before {
    content: "";
    display: inline-block;
    width: 25px;
    height: 25px;
    margin-right: 10px;
    position: absolute;
    left: 5px;
    bottom: 3px;
    border: 1px solid #555555;
    background-color: rgba(255, 255, 255, 0.5);
}
input[type=checkbox] {
    display: none;
}
input[type=checkbox]:checked + label:before {
    content: "\2713"; /* a tick */
    font-size: 25px;
    color: black;
    text-align: center;
    line-height: 25px;
}

</style>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
/*C+C+++C+++C+++C+++C+++C+++C+++C+++C+++C+++C+++C+++C+++C+++C+++C+++C
  Class:    CHandler

  Summary:  

  Methods:  Constructor
              Sets the page and register event listeners.
            Search
              Short description of MyMethodOne.
            DisplayPartiInfo
              Short description of MyMethodTwo.
            DisplayMultiplePartiInfo
              Short
            CheckIn
              Short
            ReloadPanels
              Reset UI elements. Call this on mode change.
            OnFailure
              Destructor.
C---C---C---C---C---C---C---C---C---C---C---C---C---C---C---C---C-C*/
var CHandler = function()
{
  console.log("CHandler constructor called!");
  this.ShowOnePanel('panelSearch');
  this.m_strCurrentMode = "CHECKIN";
  this.ReloadPanels();
  var that = this; //for event handler to recognize this class instead of element
  
  $( "#panelSearch form" ).submit(function(event)
  {
    that.Search();
    event.preventDefault();
  });
  $( "#panelSearch .buttonSearch" ).click(function(event)
  {
    that.Search();
  });
  $('nav #buttonModeCheckIn').click(function(event)
  {
    that.m_strCurrentMode = "CHECKIN";
    that.ReloadPanels();
  });
  $('nav #buttonModeLuggage').click(function(event)
  {
    that.m_strCurrentMode = "LUGGAGE";
    that.ReloadPanels();
  });
  
  /*--------------------------------------------------------------------
  / When Check-in Button is clicked
  --------------------------------------------------------------------*/
  $('#panelResult .buttonCheckIn').click(function(event)
  {   
    // Find which groupEachParti element does this button belongs to
    var iElemIndex = $( "#panelResult .groupEachParti .buttonCheckIn" ).index(this);
    
    // Hide check-in buttons and show loading instead
    var jParentGroupEachParti = $(this).parents('.groupEachParti');
    jParentGroupEachParti.find('.subpanelCheckIn').hide();
    jParentGroupEachParti.find('.subpanelLoading').show();
    jParentGroupEachParti.find('.messageDisplay').empty();
    
    // Get information needed
    var iHiddenRegNum = jParentGroupEachParti.find('.subpanelCheckIn .hiddenRegNum').val();
    iHiddenRegNum = parseInt(iHiddenRegNum);
    
    // Submit check-in request to server
    console.log("Check-in Request", iHiddenRegNum);
    google.script.run
    .withSuccessHandler(function(json){that.DisplayPartiInfo(json, json.CheckInStatus == '1'?'成功登記！':'已取消登記！', iElemIndex);})
    .withFailureHandler(function(e){ that.DisplayPartiInfo(null, e, iElemIndex); })
    .CheckIn(iHiddenRegNum, "Note~");
  });
  
  /*--------------------------------------------------------------------
  / When Update Luggage Button is clicked
  --------------------------------------------------------------------*/
  $('#panelResult .buttonUpdateLuggage').click(function(event)
  {    
    // Find which groupEachParti element does this button belongs to
    var iElemIndex = $( "#panelResult .groupEachParti .buttonUpdateLuggage" ).index(this);
    
    // Hide fields & buttons and show loading instead
    var jParentGroupEachParti = $(this).parents('.groupEachParti');
    jParentGroupEachParti.find('.subpanelLuggage').hide();
    jParentGroupEachParti.find('.subpanelLoading').show();
    jParentGroupEachParti.find('.messageDisplay').empty();
    
    // Get information needed
    var iHiddenRegNum = jParentGroupEachParti.find('.subpanelLuggage .hiddenRegNum').val();
    iHiddenRegNum = parseInt(iHiddenRegNum);
    
    var arrLuggages = []; //will be sent to server
    jParentGroupEachParti.find('.subpanelLuggage .groupInputLuggages .groupInputEachLuggage').each(function(i){
      //for each luggage, push its info to the array
      var strLugNum = $(this).children('.fieldLugNum').val();
      var strOut = $(this).children('.checkboxOut')[0].checked ? '1' : '0';
      arrLuggages.push({"LugNum": strLugNum, "Out": strOut});
    });
    
    // Submit update luggage request to server
    console.log("Update Luggage Request", iHiddenRegNum, arrLuggages);
    google.script.run
    .withSuccessHandler(function(json){ that.DisplayPartiInfo(json, '行李資料已更新！', iElemIndex); })
    .withFailureHandler(function(e){ that.DisplayPartiInfo(null, e, iElemIndex); })
    .UpdateLuggages(iHiddenRegNum, arrLuggages, "LuggageNote~");
  });
  
  /*--------------------------------------------------------------------
  / When Search Again Button is clicked
  --------------------------------------------------------------------*/
  $('#panelResult .buttonSearchAgain').click(function(event)
  {
    that.ReloadPanels();
  });
  
};

CHandler.prototype.Search = function()
{
  var strfieldSearch = $.trim( $('#panelSearch .fieldSearch').val() );
  if(!strfieldSearch.length || !(/^\d+$/).test(strfieldSearch) )
  {
    document.getElementById("messageError").innerHTML = "登記編號或電話號碼應全為數字。";
    this.ShowOnePanel('panelSearch');
    return;
  }
  this.ShowOnePanel('panelLoading');
  var that = this;
  if(strfieldSearch.length == 8)
  {
    // User entered phone
    google.script.run
    .withSuccessHandler(function(a){that.DisplayMultiplePartiInfo(a);})
    .withFailureHandler(function(a){that.OnFailure(a);})
    .GetParticipantInfoByPhone(strfieldSearch);
  }
  else
  {
    // User entered reg num
    google.script.run
    .withSuccessHandler(function(a){that.DisplayPartiInfo(a);})
    .withFailureHandler(function(a){that.OnFailure(a);})
    .GetParticipantInfo(strfieldSearch);
   }
};

CHandler.prototype.DisplayPartiInfo = function(jsonPartiInfo, strMessage, iElemIndex)
{
  console.log("Received PartiInfo", jsonPartiInfo);
  
  if(!iElemIndex)
    iElemIndex = 0;
  
  console.log(iElemIndex);
  
  // Display message
  var jGroupEachParti = $('#panelResult .groupEachParti').eq(iElemIndex);
  
  jGroupEachParti.find('.messageDisplay').html(strMessage ? strMessage : "");
  jGroupEachParti.children('.subpanelLoading').hide();
  
  // Display Parti Info stored in json
  if(jsonPartiInfo){
  
    jGroupEachParti.find('.tdRegNum').html(jsonPartiInfo.RegNum);
    jGroupEachParti.find('.tdName').html(jsonPartiInfo.Name);
    jGroupEachParti.find('.tdGender').html(jsonPartiInfo.Gender);
    jGroupEachParti.find('.tdPhone').html(jsonPartiInfo.Phone);
    jGroupEachParti.find('.tdEmail').html(jsonPartiInfo.Email);
    jGroupEachParti.find('.tdUID').html(jsonPartiInfo.UID);
    jGroupEachParti.find('.tdACANum').html(jsonPartiInfo.ACANum);
    jGroupEachParti.find('.tdRole').html(jsonPartiInfo.Role);
    jGroupEachParti.find('.tdResponseTime').html(jsonPartiInfo.ResponseTime);
    jGroupEachParti.find('.tdCheckInStatus').html(jsonPartiInfo.CheckInStatus == '1'? 
      '<span class="checkInStatus1">已登記</span>' :
      '<span class="checkInStatus0">尚未登記</span>');
    
    jGroupEachParti.find('.tdLuggage').empty();
    for(var i = 0; i < jsonPartiInfo.Luggages.length; i++)
    {
      var strLugNum = jsonPartiInfo.Luggages[i].LugNum;
      var strLugStatus = parseInt(jsonPartiInfo.Luggages[i].Out) == 1? 'Out' : 'In';
      jGroupEachParti.find('.tdLuggage').append( strLugNum + " (" + strLugStatus + ") ");
    }
  
  }
  
  // Perform different action for different mode
  if(this.m_strCurrentMode == "CHECKIN")
  {
    if(jsonPartiInfo){
      jGroupEachParti.find('.subpanelCheckIn .hiddenRegNum').val(jsonPartiInfo.RegNum);
      jGroupEachParti.find('.subpanelCheckIn .buttonCheckIn').val(jsonPartiInfo.CheckInStatus == '1'? '取消登記' : '登記');
    }
    jGroupEachParti.find('.subpanelCheckIn').show();
  }
  else if(this.m_strCurrentMode == "LUGGAGE")
  {
    if(jsonPartiInfo){
      jGroupEachParti.find('.subpanelLuggage .hiddenRegNum').val(jsonPartiInfo.RegNum);
      jGroupEachParti.find('.subpanelLuggage .groupInputLuggages .groupInputEachLuggage').each(function(index){
        if(!jsonPartiInfo.Luggages[index])
          return;
        var strLugNum = jsonPartiInfo.Luggages[index].LugNum;
        var strOut = jsonPartiInfo.Luggages[index].Out;
        $(this).children('.fieldLugNum').val(strLugNum);
        $(this).children('.checkboxOut').prop('checked', strOut == '1');
        
      });
    }
    jGroupEachParti.find('.subpanelLuggage').show();
  }
  
  // Everything all set, display the result panel!
  this.ShowOnePanel('panelResult');
};
  
CHandler.prototype.DisplayMultiplePartiInfo = function(arrPartiInfoMatches)
{
  console.log("Received MultiplePartiInfo", arrPartiInfoMatches);
  
  if     (arrPartiInfoMatches.length == 0) this.OnFailure({message: "此電話號碼並未登記。"});
  else if(arrPartiInfoMatches.length == 1) this.DisplayPartiInfo(arrPartiInfoMatches[0]);
  else //more than one
  {
    $('#messageMultiParti').show();
    
    this.DisplayPartiInfo(arrPartiInfoMatches[0], null, 0);
    
    var jGroupEachParti = $('#panelResult .groupEachParti');
    for(var i = 1; i < arrPartiInfoMatches.length; i++)
    {
      var jNewClone = jGroupEachParti.clone(true, true).appendTo(jGroupEachParti.parent());
      
      //make every pair of input[type=checkbox] & label unique
      
      
      jNewClone.find('.groupInputEachLuggage').each(function(index){
        var strNewId = 'L' + i + '-' + index ;
        $(this).children('.checkboxOut').attr('id', strNewId);
        $(this).children('label').attr('for', strNewId);
      });
      
      this.DisplayPartiInfo(arrPartiInfoMatches[i], null, i);
    }
  }
};

CHandler.prototype.ReloadPanels = function()
{
  // Clear & reset elements
  document.getElementById("messageError").innerHTML = "&nbsp;";
  $('.subpanelLuggage').hide();
  $('.subpanelCheckIn').hide();
  $('.tdLuggage').empty();
  $('#messageMultiParti').hide();
  $('#panelResult .groupEachParti').nextAll().remove(); //just keep one copy, remove all others
  
  // UI update for current mode
  if(this.m_strCurrentMode == "CHECKIN")
  {
    $('nav .buttonMode').removeClass('buttonModeCurrent');
    $('nav #buttonModeCheckIn').addClass('buttonModeCurrent');
    $('body').removeClass().addClass('modeCHECKIN');
  }
  else if(this.m_strCurrentMode == "LUGGAGE")
  {
    $('nav .buttonMode').removeClass('buttonModeCurrent');
    $('nav #buttonModeLuggage').addClass('buttonModeCurrent');
    $('body').removeClass().addClass('modeLUGGAGE');
  }
  this.ShowOnePanel('panelSearch');
  $('#panelSearch .fieldSearch').select();
};

CHandler.prototype.ShowOnePanel = function(strPanelToShow)
{
  $('#panelSearch').hide();
  $('#panelLoading').hide();
  $('#panelResult').hide();
  $('#' + strPanelToShow).show();
};

CHandler.prototype.OnFailure = function(error)
{
  document.getElementById("messageError").innerHTML = "錯誤：" + error.message;
  this.ShowOnePanel('panelSearch');
  $('#panelSearch .fieldSearch').select();
};

$(document).ready(function()
{
  var handler = new CHandler();
});
</script>
</head>

<body>

<header>
  <h1>香港大學學生會動漫聯盟</h1>
  <h2>Cosplay Party System 2016 工作人員界面 (測試版)</h2>
</header>

<div id="app">

  <nav>
    <span id="buttonModeCheckIn" class="buttonMode">Check-in 登記</span><span id="buttonModeLuggage" class="buttonMode">Luggage 行李寄存</span>
  </nav>
  
  <div id="panels">
  
    <div id="panelSearch">
      <p>搜尋參加者資料： </p>
      <form onsubmit="return false;">
        <input type="text" class="fieldSearch" placeholder="輸入登記編號或電話號碼..." maxlength="8" autocomplete='off' autofocus />  
        <input type="button" class="buttonSearch" value="Go!" />
      </form>
      <p id="messageError">&nbsp;</p>
      <p>可以使用登記編號或電話號碼搜尋。</p>
      <p>若想搜尋其他資料，<a href="<?= GetGoogleSheet_().getUrl(); ?>" target="_blank">可打開試算表查閱</a>。</p>
    </div>
    
    <div id="panelResult">
    
      <p id="messageMultiParti">
        <span style="color:red">此電話號碼被登記了超過一次。請確認以下哪項資料才是正確的。</span><br />
        以下幾項資料中，「已登記」狀態的會排在最上面，之後則會按網上交表時間排列。<br />
        如果資料大致相同，請為最上面的資料進行登記或更新行李（即參加者第一次網上交表時的資料）。<br />
        如果資料不太一樣（尤其是姓名），請和參加者核對哪項才是正確的資料。
      </p>
      
      <div class="groupEachParti">
    
        <div class="subpanelPartiInfo">
          <table>
            <tr><th>登記編號</th><td class="tdRegNum"></td><th class="thLuggage">行李寄存資料</th></tr>
            <tr><th>姓名</th><td class="tdName"></td><td class="tdLuggage" rowspan="8"></td></tr>
            <tr><th>性別</th><td class="tdGender"></td></tr>
            <tr><th>電話</th><td class="tdPhone"></td></tr>
            <tr><th>電郵</th><td class="tdEmail"></td></tr>
            <tr><th>UID</th><td class="tdUID"></td></tr>
            <tr><th>會員編號</th><td class="tdACANum"></td></tr>
            <tr><th>身份</th><td class="tdRole"></td></tr>
            <tr><th>網上交表時間</th><td class="tdResponseTime"></td></tr>
            <tr><th>狀態</th><td class="tdCheckInStatus"></td></tr>
          </table>
          <p class="messageDisplay"></p>
        </div>
        
        <div class="subpanelLoading">
          <img src="https://i.imgur.com/pEz3PzX.gif" /> Loading...
        </div>
        
        <div class="subpanelCheckIn">
          <input type="hidden" class="hiddenRegNum" />
          <input type="button" class="buttonCheckIn" value="登記" />
          <input type="button" class="buttonSearchAgain" value="重新搜尋" />
        </div>
        
        <div class="subpanelLuggage">
          <p>更改行李資料：</p>
          <form onsubmit="return false;">
          
            <div class="groupInputLuggages">
            
              <? for (var i = 0; i < LUGGAGE_MAX; i++) { ?>
              <div class="groupInputEachLuggage">
                <input type="text" class="fieldLugNum" placeholder="無" autocomplete='off' />
                <input type="checkbox" class="checkboxOut" id="L0-<?=i ?>" /><label for="L0-<?=i ?>">取走</label>
              </div>
              <? } ?>
              
            </div>
      
            <input type="hidden" class="hiddenRegNum" />
            <input type="button" class="buttonUpdateLuggage" value="更新行李資料" />
            <input type="button" class="buttonSearchAgain" value="重新搜尋" />
          </form>
        </div>
      
      </div>
      
    </div>
    
    <div id="panelLoading">
      <img src="https://i.imgur.com/pEz3PzX.gif" /> Loading...
    </div>
    
  </div>

</div>

<footer>
  <p>
    在此感謝各位工作人員的幫忙。<br /><br />
    &copy;2016 香港大學學生會動漫聯盟 The Animation and Comics Association, HKUSU | 
    <a href="<?= GetGoogleForm_().getPublishedUrl(); ?>" target="_blank">登記表格</a> |
    <a href="<?= GetGoogleSheet_().getUrl(); ?>" target="_blank">試算表</a>
  </p>
</footer>

</body>

</html>
